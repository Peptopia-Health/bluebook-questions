<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klimek Guide</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; min-height: 100vh; min-height: 100dvh; background: #b8aad0; }
        html.dark, html.dark body { background: #0f172a; }
    </style>
</head>
<body>
<script>
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
}
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
    if (event.matches) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
});
</script>

<div id="peptopia-klimek-guide">
    <style>
        #peptopia-klimek-guide {
            --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-200: #e2e8f0;
            --slate-700: #334155; --slate-800: #1e293b; --slate-900: #0f172a; --white: #ffffff;
            --rose-500: #fb7185; --blue-500: #06b6d4; --purple-500: #8b5cf6;
            --emerald-500: #10b981; --pink-500: #ec4899; --amber-500: #d97706;
            --teal-500: #14b8a6; --indigo-500: #6366f1; --red-600: #dc2626;
            --orange-600: #ea580c; --gray-600: #4b5563; --cyan-500: #06b6d4; --lime-500: #84cc16; --green-500: #22c55e;
            --rose-50: #fff1f2; --blue-50: #ecfeff; --purple-50: #f5f3ff;
            --emerald-50: #ecfdf5; --pink-50: #fdf2f8; --amber-50: #fffbeb;
            --teal-50: #f0fdfa; --indigo-50: #eef2ff; --red-50: #fef2f2;
            --orange-50: #fff7ed; --gray-50: #f9fafb; --cyan-50: #ecfeff; --lime-50: #f7fee7; --green-50: #f0fdf4;
            --rose-100: #ffe4e6; --blue-100: #cffafe; --purple-100: #ede9fe;
            --emerald-100: #d1fae5; --pink-100: #fce7f3; --amber-100: #fef3c7;
            --teal-100: #ccfbf1; --indigo-100: #e0e7ff; --red-100: #fee2e2;
            --orange-100: #ffedd5; --gray-100: #f3f4f6; --cyan-100: #cffafe; --lime-100: #ecfccb; --green-100: #dcfce7;
            --rose-800: #9f1239; --blue-800: #155e75; --purple-800: #5b21b6;
            --emerald-800: #065f46; --pink-800: #9d174d; --amber-800: #92400e;
            --teal-800: #115e59; --indigo-800: #3730a3; --red-800: #991b1b;
            --orange-800: #9a3412; --gray-800: #1f2937; --cyan-800: #155e75; --lime-800: #3f6212; --green-800: #166534;
            --alert-bg: #fff7ed; --alert-border: #fdba74; --alert-text: #1e293b;
            --accent-gold: #f59e0b;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: transparent; color: var(--slate-900); line-height: 1.6;
            font-size: 16px; max-width: 76rem; margin: 0 auto; padding: 0.75rem;
            box-sizing: border-box; -webkit-text-size-adjust: 100%;
        }
        html.dark #peptopia-klimek-guide {
            --slate-50: #0f172a; --slate-100: #1e293b; --slate-200: #334155;
            --slate-700: #cbd5e1; --slate-800: #0f172a; --slate-900: #f1f5f9; --white: #1e293b;
            --rose-50: #1a0a0d; --blue-50: #0a1a1f; --purple-50: #0f0a1f;
            --emerald-50: #0a1a12; --pink-50: #1a0a14; --amber-50: #1a150a;
            --teal-50: #0a1a17; --indigo-50: #0a0e1f; --red-50: #1a0a0a;
            --orange-50: #1a110a; --gray-50: #111827;
            --rose-100: #2d1015; --blue-100: #0c2530; --purple-100: #1a1035;
            --emerald-100: #0c2518; --pink-100: #2d101c; --amber-100: #2d2010;
            --teal-100: #0c2520; --indigo-100: #141835; --red-100: #2d1010;
            --orange-100: #2d1810; --gray-100: #1f2937;
            --rose-800: #fda4af; --blue-800: #67e8f9; --purple-800: #c4b5fd;
            --emerald-800: #6ee7b7; --pink-800: #f9a8d4; --amber-800: #fcd34d;
            --teal-800: #5eead4; --indigo-800: #a5b4fc; --red-800: #fca5a5;
            --orange-800: #fdba74; --gray-800: #d1d5db; --cyan-800: #67e8f9; --lime-800: #bef264; --green-800: #86efac;
            --alert-bg: #1a150a; --alert-border: #92400e; --alert-text: #f1f5f9;
            background-color: transparent; color: #f1f5f9;
        }
        #peptopia-klimek-guide * { box-sizing: border-box; }
        #peptopia-klimek-guide .highlight-term {
            background-color: #fef9c3; color: #000; padding: 0.1rem 0.4rem;
            border-radius: 0.25rem; font-weight: 800; display: inline-block; margin-bottom: 2px;
        }
        html.dark #peptopia-klimek-guide .highlight-term { background-color: #fef08a; color: #1e1b4b; }
        #peptopia-klimek-guide .hl-drug { color: #2563eb; font-weight: 700; }
        html.dark #peptopia-klimek-guide .hl-drug { color: #60a5fa; }
        #peptopia-klimek-guide .hl-lyte { color: #ea580c; font-weight: 700; }
        html.dark #peptopia-klimek-guide .hl-lyte { color: #fb923c; }
        #peptopia-klimek-guide .hl-gas { color: #16a34a; font-weight: 700; }
        html.dark #peptopia-klimek-guide .hl-gas { color: #4ade80; }
        #peptopia-klimek-guide .section-title-hl {
            background: rgba(255,255,255,0.75); padding: 0.15rem 0.5rem;
            border-radius: 0.35rem; display: inline-block;
        }
        html.dark #peptopia-klimek-guide .section-title-hl { background: rgba(255,255,255,0.15); }
        #peptopia-klimek-guide .navbar {
            background: linear-gradient(135deg, #0a1628 0%, #0c2461 50%, #0a1628 100%);
            color: #fff; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.4rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 16px -2px rgba(10, 22, 40, 0.5), 0 0 20px rgba(30, 100, 255, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.25);
            flex-wrap: nowrap; gap: 0.35rem; overflow: hidden;
        }
        html.dark #peptopia-klimek-guide .navbar { background: linear-gradient(135deg, #020617 0%, #0c2461 50%, #020617 100%); border: 1px solid rgba(59, 130, 246, 0.3); }
        #peptopia-klimek-guide .nav-title { font-weight: 800; font-size: 1.3rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; flex-shrink: 0; }
        #peptopia-klimek-guide .nav-filters {
            display: flex; gap: 0.35rem; align-items: center;
        }
        #peptopia-klimek-guide .nav-filter-btn {
            background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.2); padding: 0.3rem 0.7rem;
            border-radius: 2rem; font-size: 0.78rem; font-weight: 700;
            cursor: pointer; transition: all 0.18s; white-space: nowrap;
            -webkit-tap-highlight-color: transparent;
        }
        #peptopia-klimek-guide .nav-filter-btn:hover {
            background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.95);
            border-color: rgba(255,255,255,0.4);
        }
        #peptopia-klimek-guide .nav-filter-btn.active {
            background: rgba(99, 102, 241, 0.6); color: #fff;
            border-color: rgba(165, 180, 252, 0.7);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }
        #peptopia-klimek-guide #section-view {
            flex-direction: column;
            height: calc(100vh - 7.5rem); height: calc(100dvh - 7.5rem);
        }
        #peptopia-klimek-guide #content-area {
            display: flex; flex-direction: column; flex: 1 1 0; min-height: 0;
        }
        #peptopia-klimek-guide .section-header-bar {
            padding: 0.65rem 1rem; min-height: 44px; color: #2e1065;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 0.75rem; font-size: 1.15rem; font-weight: 800;
            margin-bottom: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); gap: 0.5rem;
            flex-wrap: wrap; flex-shrink: 0;
        }
        #peptopia-klimek-guide .section-header-bar .section-summary {
            width: 100%; font-size: 0.82rem; font-weight: 500; opacity: 0.85; margin-top: 0.15rem;
        }
        #peptopia-klimek-guide .header-btn {
            background-color: #312e81; color: white; border: 2px solid #6d28d9;
            padding: 0.45rem 1rem; border-radius: 0.5rem; font-size: 0.9rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s; white-space: nowrap; -webkit-tap-highlight-color: transparent;
        }
        #peptopia-klimek-guide .header-btn:hover { background-color: #4338ca; color: white; transform: scale(1.02); }
        #peptopia-klimek-guide .header-btns { display: flex; gap: 0.4rem; flex-shrink: 0; }
        #peptopia-klimek-guide .card-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.92); z-index: 1999;
            align-items: flex-start; justify-content: center; padding: 0;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        #peptopia-klimek-guide .card-modal {
            background: var(--white); width: 100%; max-width: 560px; border-radius: 0;
            min-height: 100vh; min-height: 100dvh; display: flex; flex-direction: column;
        }
        @media (min-width: 640px) {
            #peptopia-klimek-guide .card-overlay { align-items: center; padding: 1.5rem; }
            #peptopia-klimek-guide .card-modal { border-radius: 1rem; min-height: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        }
        html.dark #peptopia-klimek-guide .card-modal { background: #1e293b; }
        #peptopia-klimek-guide .card-modal-header {
            padding: 0.75rem 1rem; color: white; font-weight: 800; font-size: 1rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        @media (min-width: 640px) { #peptopia-klimek-guide .card-modal-header { border-radius: 1rem 1rem 0 0; } }
        #peptopia-klimek-guide .card-modal-header .card-close-btn {
            background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0 0.25rem; line-height: 1;
        }
        #peptopia-klimek-guide .card-modal-body { padding: 1.25rem; flex-grow: 1; }
        #peptopia-klimek-guide .card-modal-body .card-topic { font-size: 1.35rem; font-weight: 800; margin-bottom: 1rem; color: var(--slate-900); }
        html.dark #peptopia-klimek-guide .card-modal-body .card-topic { color: #f1f5f9; }
        #peptopia-klimek-guide .card-modal-body .card-section { margin-bottom: 1rem; }
        #peptopia-klimek-guide .card-modal-body .card-label {
            font-size: 0.72rem; text-transform: uppercase; letter-spacing: 1px;
            color: #64748b; font-weight: 800; margin-bottom: 0.3rem; display: block;
        }
        html.dark #peptopia-klimek-guide .card-modal-body .card-label { color: #94a3b8; }
        #peptopia-klimek-guide .card-modal-body .card-fact { font-size: 1.05rem; line-height: 1.5; color: var(--slate-900); }
        html.dark #peptopia-klimek-guide .card-modal-body .card-fact { color: #e2e8f0; }
        #peptopia-klimek-guide .card-modal-body .card-alert-box {
            background: #fff1f2; border-left: 5px solid #e11d48; padding: 0.75rem; border-radius: 0.25rem;
        }
        html.dark #peptopia-klimek-guide .card-modal-body .card-alert-box { background: #1c1012; border-left-color: #be123c; }
        #peptopia-klimek-guide .card-modal-body .card-alert-box .card-fact { font-size: 0.95rem; }
        #peptopia-klimek-guide .card-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; border-top: 1px solid var(--slate-200); gap: 0.5rem;
        }
        html.dark #peptopia-klimek-guide .card-nav { border-top-color: #334155; }
        #peptopia-klimek-guide .card-nav-btn {
            background: #4f46e5; color: white; border: none; padding: 0.55rem 1.25rem;
            border-radius: 2rem; font-weight: 700; cursor: pointer; font-size: 0.9rem;
            transition: background 0.15s; -webkit-tap-highlight-color: transparent;
        }
        #peptopia-klimek-guide .card-nav-btn:hover { background: #4338ca; }
        #peptopia-klimek-guide .card-nav-btn:disabled { opacity: 0.35; cursor: default; }
        #peptopia-klimek-guide .card-counter { font-size: 0.85rem; font-weight: 700; color: #64748b; white-space: nowrap; }
        html.dark #peptopia-klimek-guide .card-counter { color: #94a3b8; }
        #peptopia-klimek-guide .table-container {
            overflow-x: auto; -webkit-overflow-scrolling: touch; border: 2px solid #334155;
            border-radius: 0.75rem; background: var(--white); overflow-y: auto;
            flex: 1 1 0; min-height: 0;
        }
        html.dark #peptopia-klimek-guide .table-container { background: #1e293b; border-color: #475569; }
        #peptopia-klimek-guide table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.85rem; }
        #peptopia-klimek-guide th {
            padding: 0.65rem 0.7rem; background-color: #e2e8f0; color: #0f172a;
            border-bottom: 2px solid #cbd5e1; position: sticky; top: 0; z-index: 5;
            font-weight: 800; font-size: 0.92rem; white-space: nowrap;
        }
        html.dark #peptopia-klimek-guide th { background-color: #1e293b; color: #f1f5f9; border-bottom-color: #475569; }
        #peptopia-klimek-guide td { padding: 0.6rem 0.65rem; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        html.dark #peptopia-klimek-guide td { border-bottom-color: #334155; color: #e2e8f0; }
        #peptopia-klimek-guide tr:hover td { cursor: pointer; background-color: #f8fafc; }
        html.dark #peptopia-klimek-guide tr:hover td { background-color: #1e293b; }
        #peptopia-klimek-guide .topic-cell { font-weight: 800; white-space: nowrap; color: #000; vertical-align: top; }
        html.dark #peptopia-klimek-guide .topic-cell { color: #f1f5f9; background-color: rgba(255,255,255,0.05); }
        #peptopia-klimek-guide .topic-cell.cardio { background-color: var(--rose-50); }
        #peptopia-klimek-guide .topic-cell.resp { background-color: var(--blue-50); }
        #peptopia-klimek-guide .topic-cell.neuro { background-color: var(--purple-50); }
        #peptopia-klimek-guide .topic-cell.gi { background-color: var(--emerald-50); }
        #peptopia-klimek-guide .topic-cell.obpeds { background-color: var(--pink-50); }
        #peptopia-klimek-guide .topic-cell.endo { background-color: var(--amber-50); }
        #peptopia-klimek-guide .topic-cell.musc { background-color: var(--teal-50); }
        #peptopia-klimek-guide .topic-cell.psych { background-color: var(--indigo-50); }
        #peptopia-klimek-guide .topic-cell.hemonc { background-color: var(--red-50); }
        #peptopia-klimek-guide .topic-cell.integ { background-color: var(--orange-50); }
        #peptopia-klimek-guide .topic-cell.pharm { background-color: var(--gray-50); }
        #peptopia-klimek-guide .topic-cell.fund { background-color: var(--cyan-50); }
        #peptopia-klimek-guide .topic-cell.gero { background-color: var(--lime-50); }
        #peptopia-klimek-guide .topic-cell.nutr { background-color: var(--green-50); }
        #peptopia-klimek-guide .key-point-cell { color: #334155; font-style: normal; font-weight: 500; }
        html.dark #peptopia-klimek-guide .key-point-cell { color: #cbd5e1; }
        #peptopia-klimek-guide .alert-cell { color: #1e293b; background-color: #fef2f2; border-left: 3px solid #f87171; font-weight: 400; }
        #peptopia-klimek-guide .alert-cell .alert-key { font-weight: 700; color: #991b1b; }
        html.dark #peptopia-klimek-guide .alert-cell { background-color: #1c1012; color: #e2e8f0; border-left-color: #dc2626; }
        html.dark #peptopia-klimek-guide .alert-cell .alert-key { color: #fca5a5; }
        @media (max-width: 600px) {
            #peptopia-klimek-guide { padding: 0.4rem; }
            #peptopia-klimek-guide table, #peptopia-klimek-guide thead, #peptopia-klimek-guide tbody,
            #peptopia-klimek-guide th, #peptopia-klimek-guide td, #peptopia-klimek-guide tr { display: block; width: 100%; }
            #peptopia-klimek-guide thead { display: none; }
            #peptopia-klimek-guide tr { border-bottom: 2px solid #e2e8f0; padding: 0.6rem 0; margin-bottom: 0.35rem; }
            html.dark #peptopia-klimek-guide tr { border-bottom-color: #334155; }
            #peptopia-klimek-guide td { padding: 0.3rem 0.65rem; border-bottom: none; position: relative; padding-left: 0.65rem; }
            #peptopia-klimek-guide .topic-cell { font-size: 0.95rem; padding-bottom: 0.15rem; white-space: normal; }
            #peptopia-klimek-guide .key-point-cell::before { content: '\1F4CC '; }
            #peptopia-klimek-guide .alert-cell { border-left: 3px solid #f87171; margin: 0.2rem 0.3rem; border-radius: 0.25rem; padding: 0.4rem 0.6rem; font-size: 0.85rem; }
            #peptopia-klimek-guide .section-header-bar { font-size: 1rem; padding: 0.5rem 0.75rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
            #peptopia-klimek-guide .nav-filters { gap: 0.2rem; }
            #peptopia-klimek-guide .nav-filter-btn { font-size: 0.7rem; padding: 0.25rem 0.5rem; }
            #peptopia-klimek-guide .navbar { margin-bottom: 0.3rem; padding: 0.45rem 0.6rem; flex-wrap: nowrap; }
            #peptopia-klimek-guide .nav-title { font-size: 1rem; }
            #peptopia-klimek-guide #section-view { height: calc(100vh - 6rem); height: calc(100dvh - 6rem); }
        }
        #peptopia-klimek-guide .quiz-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.96); z-index: 2000;
            align-items: flex-start; justify-content: center; padding: 0;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        #peptopia-klimek-guide .quiz-box {
            background: #1e1b4b; width: 100%; max-width: 700px; padding: 1.25rem; border-radius: 0;
            border: none; color: white; display: flex; flex-direction: column;
            min-height: 100vh; min-height: 100dvh;
        }
        @media (min-width: 640px) {
            #peptopia-klimek-guide .quiz-overlay { align-items: center; padding: 1rem; }
            #peptopia-klimek-guide .quiz-box {
                border-radius: 1rem; min-height: auto; max-height: none;
                border: 1px solid #4338ca; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); padding: 1.75rem;
            }
        }
        #peptopia-klimek-guide .quiz-question-number {
            background: #4338ca; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; margin-right: 0.75rem; flex-shrink: 0; font-size: 0.9rem;
        }
        #peptopia-klimek-guide .quiz-header-row { display: flex; align-items: flex-start; margin-bottom: 1.25rem; }
        #peptopia-klimek-guide .quiz-question-text { font-size: 1.1rem; line-height: 1.5; font-weight: 500; }
        #peptopia-klimek-guide .quiz-option {
            background: #312e81; border: 2px solid #4338ca; padding: 0.85rem; margin-bottom: 0.5rem;
            border-radius: 0.5rem; cursor: pointer; transition: all 0.15s; display: flex; align-items: center;
            font-size: 1rem; color: #e0e7ff; width: 100%; text-align: left;
            -webkit-tap-highlight-color: transparent; user-select: none;
        }
        #peptopia-klimek-guide .quiz-option:hover { background: #3730a3; border-color: #6366f1; }
        #peptopia-klimek-guide .quiz-option.correct-choice { background: #064e3b; border-color: #10b981; color: white; }
        #peptopia-klimek-guide .quiz-option.wrong-choice { background: #7f1d1d; border-color: #ef4444; color: white; opacity: 0.8; }
        #peptopia-klimek-guide .quiz-option-letter {
            background: rgba(255,255,255,0.1); width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin-right: 0.75rem; font-weight: 700; font-size: 0.85rem; flex-shrink: 0;
        }
        #peptopia-klimek-guide .feedback-container { margin-top: 1rem; background: #312e81; border-radius: 0.5rem; border: 1px solid #4338ca; }
        #peptopia-klimek-guide .feedback-container[style*="display: block"],
        #peptopia-klimek-guide .feedback-container.is-visible { display: block !important; }
        #peptopia-klimek-guide .feedback-header { padding: 0.6rem 0.85rem; font-weight: 800; display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; }
        #peptopia-klimek-guide .feedback-header.correct { background: #065f46; color: #34d399; border-radius: 0.5rem 0.5rem 0 0; }
        #peptopia-klimek-guide .feedback-header.incorrect { background: #7f1d1d; color: #fca5a5; border-radius: 0.5rem 0.5rem 0 0; }
        #peptopia-klimek-guide .feedback-content { padding: 0.85rem; font-size: 0.95rem; line-height: 1.6; color: #e0e7ff; }
        #peptopia-klimek-guide .rationale-label { color: #a5b4fc; font-weight: 800; display: block; margin-bottom: 0.4rem; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        #peptopia-klimek-guide .quiz-footer { margin-top: 1.25rem; display: flex; justify-content: center; align-items: center; padding-bottom: env(safe-area-inset-bottom, 0.5rem); }
        #peptopia-klimek-guide .next-q-btn {
            background: #4f46e5; color: white; border: none; padding: 0.75rem 2.5rem;
            border-radius: 2rem; font-weight: 800; cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); font-size: 1rem;
            -webkit-tap-highlight-color: transparent; width: 100%; max-width: 320px;
        }
        #peptopia-klimek-guide .next-q-btn:hover { background: #4338ca; }
        #peptopia-klimek-guide .section-header-bar.bg-rose { background-color: #fecdd3; border: 2px solid #f43f5e; }
        #peptopia-klimek-guide .section-header-bar.bg-blue { background-color: #a5f3fc; border: 2px solid #06b6d4; }
        #peptopia-klimek-guide .section-header-bar.bg-purple { background-color: #ddd6fe; border: 2px solid #7c3aed; }
        #peptopia-klimek-guide .section-header-bar.bg-emerald { background-color: #a7f3d0; border: 2px solid #059669; }
        #peptopia-klimek-guide .section-header-bar.bg-pink { background-color: #fbcfe8; border: 2px solid #db2777; }
        #peptopia-klimek-guide .section-header-bar.bg-amber { background-color: #fde68a; border: 2px solid #d97706; }
        #peptopia-klimek-guide .section-header-bar.bg-teal { background-color: #99f6e4; border: 2px solid #0d9488; }
        #peptopia-klimek-guide .section-header-bar.bg-indigo { background-color: #c7d2fe; border: 2px solid #4f46e5; }
        #peptopia-klimek-guide .section-header-bar.bg-red { background-color: #fecaca; border: 2px solid #dc2626; }
        #peptopia-klimek-guide .section-header-bar.bg-orange { background-color: #fed7aa; border: 2px solid #ea580c; }
        #peptopia-klimek-guide .section-header-bar.bg-gray { background-color: #e5e7eb; border: 2px solid #6b7280; }
        #peptopia-klimek-guide .section-header-bar.bg-cyan { background-color: #a5f3fc; border: 2px solid #0891b2; }
        #peptopia-klimek-guide .section-header-bar.bg-lime { background-color: #d9f99d; border: 2px solid #65a30d; }
        #peptopia-klimek-guide .section-header-bar.bg-green { background-color: #bbf7d0; border: 2px solid #16a34a; }
        html.dark #peptopia-klimek-guide .section-header-bar { color: #c4b5fd; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-rose { background-color: #4c0519; border-color: #be123c; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-blue { background-color: #083344; border-color: #0891b2; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-purple { background-color: #2e1065; border-color: #6d28d9; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-emerald { background-color: #022c22; border-color: #047857; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-pink { background-color: #500724; border-color: #be185d; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-amber { background-color: #451a03; border-color: #b45309; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-teal { background-color: #042f2e; border-color: #0f766e; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-indigo { background-color: #1e1b4b; border-color: #4338ca; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-red { background-color: #450a0a; border-color: #b91c1c; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-orange { background-color: #431407; border-color: #c2410c; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-gray { background-color: #1f2937; border-color: #4b5563; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-cyan { background-color: #083344; border-color: #0891b2; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-lime { background-color: #1a2e05; border-color: #4d7c0f; }
        html.dark #peptopia-klimek-guide .section-header-bar.bg-green { background-color: #052e16; border-color: #15803d; }
        #peptopia-klimek-guide .card-modal-header.bg-rose { background-color: var(--rose-500); }
        #peptopia-klimek-guide .card-modal-header.bg-blue { background-color: var(--blue-500); }
        #peptopia-klimek-guide .card-modal-header.bg-purple { background-color: var(--purple-500); }
        #peptopia-klimek-guide .card-modal-header.bg-emerald { background-color: var(--emerald-500); }
        #peptopia-klimek-guide .card-modal-header.bg-pink { background-color: var(--pink-500); }
        #peptopia-klimek-guide .card-modal-header.bg-amber { background-color: var(--amber-500); }
        #peptopia-klimek-guide .card-modal-header.bg-teal { background-color: var(--teal-500); }
        #peptopia-klimek-guide .card-modal-header.bg-indigo { background-color: var(--indigo-500); }
        #peptopia-klimek-guide .card-modal-header.bg-red { background-color: var(--red-600); }
        #peptopia-klimek-guide .card-modal-header.bg-orange { background-color: var(--orange-600); }
        #peptopia-klimek-guide .card-modal-header.bg-gray { background-color: var(--gray-600); }
        #peptopia-klimek-guide .card-modal-header.bg-cyan { background-color: var(--cyan-500); }
        #peptopia-klimek-guide .card-modal-header.bg-lime { background-color: var(--lime-500); }
        #peptopia-klimek-guide .card-modal-header.bg-green { background-color: var(--green-500); }
        #peptopia-klimek-guide .home-hero { text-align: center; padding: 0; }
        #peptopia-klimek-guide .home-hero-banner {
            background: linear-gradient(135deg, #0a1628 0%, #0c2461 50%, #0a1628 100%);
            color: rgba(255,255,255,0.92); padding: 0.55rem 1rem; border-radius: 0.5rem;
            font-size: 0.92rem; font-weight: 600; line-height: 1.5; margin-bottom: 0.4rem;
            box-shadow: 0 4px 16px -2px rgba(10, 22, 40, 0.5), 0 0 20px rgba(30, 100, 255, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        #peptopia-klimek-guide .version-tag { color: rgba(255,255,255,0.35); font-weight: 400; font-size: 0.85em; }
        #peptopia-klimek-guide .search-input {
            width: 100%; padding: 0.5rem 1rem; font-size: 16px; border-radius: 8px;
            border: 1px solid #6366f1; background: #ffffff; color: #1e293b;
            outline: none; box-sizing: border-box; text-align: center;
        }
        #peptopia-klimek-guide .search-input:focus { text-align: left; }
        html.dark #peptopia-klimek-guide .search-input { background: #1e293b; color: #f1f5f9; border-color: #6366f1; }
        #peptopia-klimek-guide .search-input::placeholder { color: #94a3b8; }
        html.dark #peptopia-klimek-guide .search-input::placeholder { color: #64748b; }
        #peptopia-klimek-guide .search-result-item {
            padding: 0.6rem 0.75rem; margin-bottom: 0.4rem; border-radius: 8px;
            border-left: 4px solid var(--indigo-500); background: #f1f5f9; cursor: pointer;
        }
        #peptopia-klimek-guide .search-result-item:hover { background: #e2e8f0; }
        html.dark #peptopia-klimek-guide .search-result-item { background: #1e293b; }
        html.dark #peptopia-klimek-guide .search-result-item:hover { background: #334155; }
        html.dark #peptopia-klimek-guide .home-hero-banner {
            background: linear-gradient(135deg, #020617 0%, #0c2461 50%, #020617 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        #peptopia-klimek-guide .home-grid {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 0.75rem; margin-bottom: 2rem;
        }
        #peptopia-klimek-guide .home-grid .home-card { flex: 0 1 calc(25% - 0.6rem); min-width: 250px; }
        @media (max-width: 600px) { #peptopia-klimek-guide .home-grid .home-card { flex: 0 0 100%; min-width: 0; } }
        #peptopia-klimek-guide .home-card {
            border-radius: 0.75rem; overflow: hidden; cursor: pointer;
            transition: transform 0.18s, box-shadow 0.18s; background: var(--white);
            border: 2px solid var(--slate-200); display: flex; flex-direction: column;
            animation: cardSlideUp 0.4s ease-out both;
        }
        html.dark #peptopia-klimek-guide .home-card { background: #1e293b; border-color: #334155; }
        #peptopia-klimek-guide .home-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px -4px rgba(0,0,0,0.15); }
        html.dark #peptopia-klimek-guide .home-card:hover { box-shadow: 0 8px 24px -4px rgba(0,0,0,0.4); }
        #peptopia-klimek-guide .home-card-header { padding: 0.7rem 0.85rem; font-weight: 800; font-size: 1.15rem; display: flex; align-items: center; gap: 0.5rem; }
        #peptopia-klimek-guide .home-card-header .home-card-emoji { font-size: 1.2rem; }
        #peptopia-klimek-guide .home-card-body { padding: 0.5rem 0.85rem 0.35rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; }
        #peptopia-klimek-guide .home-card-desc { font-size: 0.82rem; line-height: 1.45; margin-bottom: 0; }
        #peptopia-klimek-guide .home-card-footer { padding: 0.5rem 0.85rem 0.65rem; border-top: 1px solid var(--slate-200); display: flex; gap: 0.4rem; }
        html.dark #peptopia-klimek-guide .home-card-footer { border-top-color: #334155; }
        #peptopia-klimek-guide .home-grid-divider { border: none; border-top: 1px solid var(--slate-200); margin: 0.5rem 1.5rem 1rem; }
        html.dark #peptopia-klimek-guide .home-grid-divider { border-top-color: #334155; }
        #peptopia-klimek-guide .home-card-btn { font-size: 0.78rem; font-weight: 700; padding: 0.35rem 0.7rem; border-radius: 0.35rem; border: none; cursor: pointer; transition: all 0.15s; -webkit-tap-highlight-color: transparent; }
        #peptopia-klimek-guide .home-card-btn.study-btn { background: #eef2ff; color: #4338ca; }
        html.dark #peptopia-klimek-guide .home-card-btn.study-btn { background: #1e1b4b; color: #a5b4fc; }
        #peptopia-klimek-guide .home-card-btn.study-btn:hover { background: #c7d2fe; }
        html.dark #peptopia-klimek-guide .home-card-btn.study-btn:hover { background: #312e81; }
        #peptopia-klimek-guide .home-card-btn.quiz-btn { background: #312e81; color: white; }
        #peptopia-klimek-guide .home-card-btn.quiz-btn:hover { background: #4338ca; }
        #peptopia-klimek-guide .home-nav-btn {
            background: none; border: 1px solid rgba(255,255,255,0.4); color: rgba(255,255,255,0.9);
            padding: 0.3rem 0.65rem; border-radius: 0.35rem; font-size: 0.8rem; font-weight: 700;
            cursor: pointer; transition: all 0.15s; -webkit-tap-highlight-color: transparent; display: none;
        }
        #peptopia-klimek-guide .home-nav-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); }
        @keyframes cardSlideUp { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }
        #peptopia-klimek-guide .navbar-pdf-btn {
            background: #312e81; color: white; border: 2px solid rgba(255,255,255,0.5);
            padding: 0.3rem 0.65rem; border-radius: 0.35rem; font-size: 0.8rem; font-weight: 700;
            cursor: pointer; transition: all 0.15s; -webkit-tap-highlight-color: transparent; white-space: nowrap; flex-shrink: 0;
        }
        #peptopia-klimek-guide .navbar-pdf-btn:hover { background: white; color: #312e81; }
        #peptopia-klimek-guide .pdf-view {
            display: none; border-radius: 0.75rem; overflow: hidden;
            border: 2px solid var(--slate-200); height: calc(100vh - 130px); height: calc(100dvh - 130px);
        }
        html.dark #peptopia-klimek-guide .pdf-view { border-color: #334155; }
        #peptopia-klimek-guide .pdf-layout { display: flex; height: 100%; }
        #peptopia-klimek-guide .pdf-sidebar {
            width: 250px; min-width: 250px; background: linear-gradient(180deg, #0a1628 0%, #0c1e3d 100%);
            color: #e0e7ff; overflow-y: auto; border-right: 1px solid rgba(59, 130, 246, 0.25); padding: 0.5rem 0;
        }
        #peptopia-klimek-guide .pdf-sidebar-cat {
            padding: 0.6rem 0.85rem; font-weight: 800; font-size: 0.82rem; color: #818cf8;
            text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center;
            gap: 0.5rem; cursor: pointer; user-select: none;
        }
        #peptopia-klimek-guide .pdf-sidebar-cat:hover { background: rgba(255,255,255,0.05); }
        #peptopia-klimek-guide .pdf-sidebar-cat .cat-arrow { transition: transform 0.2s; display: inline-block; font-size: 0.7rem; }
        #peptopia-klimek-guide .pdf-sidebar-cat .cat-arrow.open { transform: rotate(90deg); }
        #peptopia-klimek-guide .pdf-sidebar-items { overflow: hidden; }
        #peptopia-klimek-guide .pdf-sidebar-item {
            padding: 0.5rem 0.85rem 0.5rem 1.6rem; font-size: 0.88rem; cursor: pointer;
            transition: background 0.15s; display: flex; align-items: center; gap: 0.5rem;
        }
        #peptopia-klimek-guide .pdf-sidebar-item:hover { background: rgba(99, 102, 241, 0.2); }
        #peptopia-klimek-guide .pdf-sidebar-item.active { background: rgba(99, 102, 241, 0.3); color: white; font-weight: 700; }
        #peptopia-klimek-guide .pdf-viewer-pane {
            flex: 1; display: flex; flex-direction: column; background: #1e1b4b; position: relative;
        }
        #peptopia-klimek-guide .pdf-canvas-wrap {
            flex: 1; overflow: auto; display: flex; justify-content: center;
            align-items: flex-start; padding: 1rem;
        }
        #peptopia-klimek-guide .pdf-canvas-wrap canvas { max-width: 100%; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        #peptopia-klimek-guide .pdf-toolbar {
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.6rem; background: #0f0e2a; border-top: 1px solid rgba(99, 102, 241, 0.3); flex-wrap: wrap;
        }
        #peptopia-klimek-guide .pdf-tb { background: #312e81; color: white; border: none; padding: 0.45rem 0.85rem; border-radius: 0.4rem; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: background 0.15s; }
        #peptopia-klimek-guide .pdf-tb:hover { background: #4338ca; }
        #peptopia-klimek-guide .pdf-tb:disabled { opacity: 0.4; cursor: default; }
        #peptopia-klimek-guide .pdf-tb.dl { background: #059669; }
        #peptopia-klimek-guide .pdf-tb.dl:hover { background: #047857; }
        #peptopia-klimek-guide .pdf-tb.cl { background: #dc2626; }
        #peptopia-klimek-guide .pdf-tb.cl:hover { background: #b91c1c; }
        #peptopia-klimek-guide .pdf-info { color: #a5b4fc; font-size: 0.85rem; font-weight: 700; white-space: nowrap; }
        #peptopia-klimek-guide .pdf-placeholder {
            flex: 1; display: flex; align-items: center; justify-content: center;
            color: #6366f1; font-size: 1.1rem; font-weight: 600; text-align: center; padding: 2rem;
        }
        #peptopia-klimek-guide .pdf-loading { color: #818cf8; font-size: 0.95rem; text-align: center; padding: 2rem; }
        @media (max-width: 768px) {
            #peptopia-klimek-guide .pdf-layout { flex-direction: column; }
            #peptopia-klimek-guide .pdf-sidebar { width: 100%; min-width: unset; max-height: 180px; border-right: none; border-bottom: 1px solid rgba(59,130,246,0.25); }
            #peptopia-klimek-guide .pdf-view { height: calc(100vh - 100px); height: calc(100dvh - 100px); }
            #peptopia-klimek-guide .navbar-pdf-btn { font-size: 0.72rem; padding: 0.25rem 0.5rem; }
        }
    </style>

    <nav class="navbar">
        <div class="nav-title" onclick="showHome()">Klimek Guide</div>
        <div class="nav-filters" id="nav-filters">
            <button class="nav-filter-btn active" id="filter-all" onclick="filterDashboard('all')">All Topics</button>
            <button class="nav-filter-btn" id="filter-systems" onclick="filterDashboard('systems')">Systems</button>
            <button class="nav-filter-btn" id="filter-foundations" onclick="filterDashboard('foundations')">Foundations</button>
        </div>
        <div style="display:flex; gap:0.4rem; align-items:center;">
            <button class="home-nav-btn" id="home-back-btn" onclick="showHome()">&#8592; Home</button>
            <button class="navbar-pdf-btn" id="pdf-nav-btn" onclick="showPDFs()">&#128196; PDFs</button>
        </div>
    </nav>

    <div id="home-dashboard"></div>

    <div id="section-view" style="display:none;">
        <div id="content-area"></div>
    </div>

    <div id="quiz-modal" class="quiz-overlay">
        <div class="quiz-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                <span style="color:#818cf8; font-weight:700;" id="quiz-progress">Question 1 of ?</span>
                <button onclick="closeQuiz()" style="background:none; border:none; color:#818cf8; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="quiz-header-row">
                <div class="quiz-question-number" id="q-num-display">1</div>
                <div class="quiz-question-text" id="q-text"></div>
            </div>
            <div id="q-options"></div>
            <div id="feedback-area" class="feedback-container">
                <div class="feedback-header" id="feedback-header"></div>
                <div class="feedback-content">
                    <span class="rationale-label">Rationale:</span>
                    <span id="rationale-text"></span>
                </div>
            </div>
            <div class="quiz-footer">
                <button class="next-q-btn" id="next-btn" style="display:none;" onclick="nextQuestion()">Next Question</button>
            </div>
        </div>
    </div>

    <div id="card-modal" class="card-overlay">
        <div class="card-modal">
            <div class="card-modal-header" id="card-modal-header">
                <span id="card-modal-title">Study Cards</span>
                <button class="card-close-btn" onclick="closeCards()">&times;</button>
            </div>
            <div class="card-modal-body" id="card-modal-body"></div>
            <div class="card-nav">
                <button class="card-nav-btn" id="card-prev-btn" onclick="prevCard()">&#8592; Prev</button>
                <span class="card-counter" id="card-counter">1 / ?</span>
                <button class="card-nav-btn" id="card-next-btn" onclick="nextCard()">Next &#8594;</button>
            </div>
            <div style="text-align:center; padding: 0 0 0.5rem;">
                <button class="card-nav-btn" id="card-shuffle-btn" onclick="shuffleCards()" style="font-size:0.85rem; opacity:0.8;">&#x1F500; Shuffle</button>
            </div>
        </div>
    </div>

    <div id="pdf-view" class="pdf-view">
        <div class="pdf-layout">
            <div class="pdf-sidebar" id="pdf-sidebar">
                <div class="pdf-loading">Loading PDF menu...</div>
            </div>
            <div class="pdf-viewer-pane">
                <div class="pdf-canvas-wrap" id="pdf-canvas-wrap">
                    <div class="pdf-placeholder" id="pdf-placeholder">Select a PDF from the menu to begin studying</div>
                    <canvas id="pdf-canvas" style="display:none;"></canvas>
                </div>
                <div class="pdf-toolbar" id="pdf-toolbar" style="display:none;">
                    <button class="pdf-tb" id="pdf-prev" onclick="pdfPrevPage()">&#9664; Prev</button>
                    <span class="pdf-info" id="pdf-page-info">Page 1 of 1</span>
                    <button class="pdf-tb" id="pdf-next" onclick="pdfNextPage()">Next &#9654;</button>
                    <button class="pdf-tb" onclick="pdfZoomOut()">&minus;</button>
                    <span class="pdf-info" id="pdf-zoom-info">100%</span>
                    <button class="pdf-tb" onclick="pdfZoomIn()">+</button>
                    <button class="pdf-tb dl" onclick="pdfDownload()">&#11015; Download</button>
                    <button class="pdf-tb cl" onclick="closePdf()">&#10005; Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        var loadingEl = document.getElementById('home-dashboard');
        loadingEl.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--slate-900);font-weight:600;">Loading study data...</div>';

        var GH_CDN = 'https://cdn.jsdelivr.net/gh/Peptopia-Health/bluebook-questions@main/';
        var GH_PAGES = 'https://peptopia-health.github.io/bluebook-questions/';
        var CACHE_BUST = '?v=1.4';

        fetch(GH_CDN + 'mnt_studydata.json' + CACHE_BUST)
            .then(function(r) {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json();
            })
            .then(function(data) {
                window.contentData = data;
                initApp();
            })
            .catch(function(err) {
                loadingEl.innerHTML =
                    '<div style="text-align:center;padding:2rem;color:#dc2626;font-weight:700;">' +
                    'Error: Study data failed to load.' +
                    '<br><small style="color:#94a3b8;font-weight:400;">' + err.message + '</small></div>';
            });

        var APP_VERSION = '1.3';
        var QUIZ_COUNTS = { cardio:116, resp:112, neuro:100, gi:100, obpeds:114, endo:114, musc:100, psych:118, hemonc:112, integ:100, pharm:114, fund:120, gero:95, nutr:95 };

        function buildBannerText() {
            var secs = Object.keys(contentData).length;
            var cards = 0;
            Object.keys(contentData).forEach(function(k) { cards += contentData[k].data.length; });
            var quizQs = 0;
            Object.keys(QUIZ_COUNTS).forEach(function(k) { quizQs += QUIZ_COUNTS[k]; });
            return 'NCLEX review &mdash; ' + secs + ' specialties, ' + cards + ' study cards &amp; ' + quizQs.toLocaleString() + ' quiz questions.&nbsp; &nbsp;<span class="version-tag">[v' + APP_VERSION + ']</span>';
        }

        function initApp() {
        loadingEl.innerHTML =
            '<div class="home-hero"><div class="home-hero-banner" id="hero-banner"></div></div>' +
            '<div style="padding: 0.25rem 1rem 0.4rem; max-width: 600px; margin: 0 auto;">' +
            '<input type="text" id="global-search" class="search-input" placeholder="Search all cards... (e.g. Digoxin, ABG, delegation)" oninput="doGlobalSearch(this.value)"></div>' +
            '<div id="search-results" style="display:none; padding:0.5rem 1rem; max-width:700px; margin:0 auto;"></div>' +
            '<div id="home-grid">' +
            '<div class="home-grid" id="home-grid-systems"></div>' +
            '<div class="home-grid-divider" id="home-grid-divider"></div>' +
            '<div class="home-grid" id="home-grid-foundations"></div></div>';
        document.getElementById('hero-banner').innerHTML = buildBannerText();

        var sectionEmojis = {
            cardio: '\u2764\uFE0F', resp: '\uD83D\uDCA8', neuro: '\uD83E\uDDE0', gi: '\uD83C\uDF7D\uFE0F', obpeds: '\uD83D\uDC76',
            endo: '\u2697\uFE0F', musc: '\uD83E\uDDB4', psych: '\uD83E\uDDD8', hemonc: '\uD83E\uDE78', integ: '\uD83E\uDE79', pharm: '\uD83D\uDC8A',
            fund: '\uD83D\uDCCB', gero: '\uD83E\uDDD3', nutr: '\uD83E\uDD57'
        };
        var sectionSummaries = {
            cardio: 'Heart failure, rhythms, shock, vascular disorders',
            resp: 'COPD, asthma, ventilators, oxygen therapy',
            neuro: 'Stroke, seizures, ICP, spinal cord injuries',
            gi: 'GI disorders, renal failure, electrolytes, tube feeding',
            obpeds: 'Maternity, labor, newborn care, pediatric conditions',
            endo: 'Diabetes, thyroid, adrenal, hormone regulation',
            musc: 'Fractures, traction, mobility, joint replacements',
            psych: 'Crisis intervention, therapeutic communication, psych meds',
            hemonc: 'Blood types, transfusions, cancer treatment, anemias',
            integ: 'Burns, wound care, pressure ulcers, skin conditions',
            pharm: 'Drug safety, dosing, interactions, acid-base balance',
            fund: 'Delegation, prioritization, infection control, leadership',
            gero: 'Aging changes, polypharmacy, dementia, fall prevention',
            nutr: 'Vitamins, minerals, therapeutic diets, nutritional support'
        };
        var colorBaseMap = {
            'bg-rose': 'rose', 'bg-blue': 'blue', 'bg-purple': 'purple',
            'bg-emerald': 'emerald', 'bg-pink': 'pink', 'bg-amber': 'amber',
            'bg-teal': 'teal', 'bg-indigo': 'indigo', 'bg-red': 'red',
            'bg-orange': 'orange', 'bg-gray': 'gray', 'bg-cyan': 'cyan', 'bg-lime': 'lime', 'bg-green': 'green'
        };

        var GROUPS = {
            systems: ['cardio','resp','neuro','gi','obpeds','endo','musc','psych','hemonc','integ'],
            foundations: ['pharm','fund','gero','nutr']
        };
        var activeFilter = 'all';

        var currentTab = 'cardio';
        var isHome = true;
        var quizIndex = 0;
        var quizScore = 0;
        var currentQuizData = [];
        var cardIndex = 0;
        var ghQuizCache = {};

        var audioCtx = null;
        function getAudioCtx() {
            if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return null; } }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            return audioCtx;
        }
        function playSound(type) {
            var ctx = getAudioCtx();
            if (!ctx) return;
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.start(); osc.stop(ctx.currentTime + 0.1);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, ctx.currentTime);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.start(); osc.stop(ctx.currentTime + 0.2);
            }
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i]; array[i] = array[j]; array[j] = temp;
            }
            return array;
        }

        function sentenceBreak(html) {
            /* Insert <br> between sentences while preserving existing <br> tags and HTML spans.
               Splits on '. ' followed by an uppercase letter or HTML tag, and on '. ' at end of common patterns. */
            return html
                .replace(/\.\s+(?=[A-Z<])/g, '.<br>')  /* period + space + uppercase/tag */
                .replace(/;\s+/g, ';<br>')              /* semicolon lists */
                .replace(/\)\.\s*/g, ').<br>')          /* closing paren + period */
                .replace(/<br>\s*<br>/g, '<br>');        /* collapse double breaks */
        }
        function renderCardInModal(item, data, idx, total) {
            document.getElementById('card-modal-header').className = 'card-modal-header ' + data.color;
            document.getElementById('card-modal-title').textContent = data.title + ' \u2014 Study Cards';
            document.getElementById('card-counter').textContent = (idx + 1) + ' / ' + total;
            document.getElementById('card-prev-btn').disabled = (idx === 0);
            document.getElementById('card-next-btn').disabled = (idx >= total - 1);
            document.getElementById('card-modal-body').innerHTML =
                '<div class="card-topic">' + fmtText(item.topic) + '</div>' +
                '<div class="card-section"><span class="card-label">Key Fact</span><div class="card-fact">' + sentenceBreak(fmtText(item.fact)) + '</div></div>' +
                '<div class="card-section"><div class="card-alert-box"><span class="card-label" style="color:#b91c1c;">\u26A0\uFE0F Clinical Alert</span><div class="card-fact">' + sentenceBreak(fmtText(item.alert, { noCaut: true })) + '</div></div></div>';
        }

        var shuffledDeck = null;
        function getCardDeck() { return shuffledDeck || contentData[currentTab].data; }
        window.openCards = function(startIdx) {
            var data = contentData[currentTab];
            shuffledDeck = null;
            cardIndex = (typeof startIdx === 'number') ? startIdx : 0;
            var deck = getCardDeck();
            renderCardInModal(deck[cardIndex], data, cardIndex, deck.length);
            document.getElementById('card-modal').style.display = 'flex';
        };
        window.prevCard = function() {
            var data = contentData[currentTab];
            var deck = getCardDeck();
            if (cardIndex > 0) { cardIndex--; renderCardInModal(deck[cardIndex], data, cardIndex, deck.length); }
        };
        window.nextCard = function() {
            var data = contentData[currentTab];
            var deck = getCardDeck();
            if (cardIndex < deck.length - 1) { cardIndex++; renderCardInModal(deck[cardIndex], data, cardIndex, deck.length); }
        };
        window.shuffleCards = function() {
            var data = contentData[currentTab];
            var arr = data.data.slice();
            for (var i = arr.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = arr[i]; arr[i] = arr[j]; arr[j] = t; }
            shuffledDeck = arr;
            cardIndex = 0;
            renderCardInModal(arr[0], data, 0, arr.length);
        };
        window.closeCards = function() { document.getElementById('card-modal').style.display = 'none'; shuffledDeck = null; };

        window.switchTab = function(tabName) {
            currentTab = tabName;
            isHome = false;
            document.getElementById('home-dashboard').style.display = 'none';
            document.getElementById('section-view').style.display = 'flex';
            document.getElementById('pdf-view').style.display = 'none';
            document.getElementById('home-back-btn').style.display = 'inline-block';
            document.getElementById('nav-filters').style.display = 'none';
            renderContent();
        };

        window.showHome = function() {
            isHome = true;
            document.getElementById('home-dashboard').style.display = 'block';
            document.getElementById('section-view').style.display = 'none';
            document.getElementById('pdf-view').style.display = 'none';
            document.getElementById('home-back-btn').style.display = 'none';
            document.getElementById('nav-filters').style.display = '';
            var srchEl = document.getElementById('global-search');
            if (srchEl) { srchEl.value = ''; }
            var srchRes = document.getElementById('search-results');
            if (srchRes) { srchRes.style.display = 'none'; }
            var hGrid = document.getElementById('home-grid');
            if (hGrid) { hGrid.style.display = ''; }
            renderDashboard();
        };

        window.filterDashboard = function(group) {
            activeFilter = group;
            var filterBtns = document.querySelectorAll('.nav-filter-btn');
            for (var i = 0; i < filterBtns.length; i++) {
                filterBtns[i].classList.remove('active');
            }
            document.getElementById('filter-' + group).classList.add('active');
            /* If we are not on home, go home first */
            if (!isHome) { showHome(); }
            applyFilter();
        };

        function applyFilter() {
            var cards = document.querySelectorAll('#home-grid .home-card');
            for (var i = 0; i < cards.length; i++) {
                var key = cards[i].getAttribute('data-section');
                if (activeFilter === 'all') {
                    cards[i].style.display = '';
                } else if (activeFilter === 'systems') {
                    cards[i].style.display = (GROUPS.systems.indexOf(key) !== -1) ? '' : 'none';
                } else if (activeFilter === 'foundations') {
                    cards[i].style.display = (GROUPS.foundations.indexOf(key) !== -1) ? '' : 'none';
                }
            }
            var divider = document.getElementById('home-grid-divider');
            var systemsGrid = document.getElementById('home-grid-systems');
            var foundationsGrid = document.getElementById('home-grid-foundations');
            if (divider) {
                if (activeFilter === 'all') {
                    divider.style.display = '';
                    systemsGrid.style.display = '';
                    foundationsGrid.style.display = '';
                } else if (activeFilter === 'systems') {
                    divider.style.display = 'none';
                    systemsGrid.style.display = '';
                    foundationsGrid.style.display = 'none';
                } else if (activeFilter === 'foundations') {
                    divider.style.display = 'none';
                    systemsGrid.style.display = 'none';
                    foundationsGrid.style.display = '';
                }
            }
        }

        function renderDashboard() {
            var keys = Object.keys(contentData);
            var systemsHtml = '';
            var foundationsHtml = '';
            var idx = 0;
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var sec = contentData[key];
                var emoji = sectionEmojis[key] || '\uD83D\uDCCB';
                var cBase = colorBaseMap[sec.color] || 'gray';
                var cardHtml = '<div class="home-card" data-section="' + key + '" style="animation-delay:' + (idx * 0.04) + 's;" onclick="switchTab(\'' + key + '\')">' +
                    '<div class="home-card-header" style="background-color:var(--' + cBase + '-100); color:var(--' + cBase + '-800);">' +
                        '<span class="home-card-emoji">' + emoji + '</span><span>' + sec.title + '</span></div>' +
                    '<div class="home-card-body"><div class="home-card-desc" style="color:var(--' + cBase + '-800);">' + sec.description + '</div></div>' +
                    '<div class="home-card-footer">' +
                        '<button class="home-card-btn study-btn" onclick="event.stopPropagation(); switchTab(\'' + key + '\'); openCards(0);">' + sec.data.length + ' Study Cards</button>' +
                        '<button class="home-card-btn quiz-btn" onclick="event.stopPropagation(); switchTab(\'' + key + '\'); setTimeout(startQuiz, 100);">\uD83E\uDDE0 Quiz Me</button></div></div>';
                if (GROUPS.foundations.indexOf(key) !== -1) {
                    foundationsHtml += cardHtml;
                } else {
                    systemsHtml += cardHtml;
                }
                idx++;
            }
            document.getElementById('home-grid-systems').innerHTML = systemsHtml;
            document.getElementById('home-grid-foundations').innerHTML = foundationsHtml;
            applyFilter();
        }

        /* Term highlighting: drugs, electrolytes, gases, icons */
        var _termMap = {}, _termPats = [];
        (function() {
            var lists = {
                'hl-drug': 'Magnesium Sulfate|Calcium Gluconate|Valproic Acid|Carbon Dioxide|Vitamin K|Digoxin|Nitroglycerin|Warfarin|Coumadin|Heparin|Enoxaparin|Lovenox|Morphine|Meperidine|Demerol|Fentanyl|Hydrocodone|Oxycodone|Codeine|Tramadol|Epinephrine|Norepinephrine|Dopamine|Dobutamine|Atropine|Adenosine|Amiodarone|Lidocaine|Metoprolol|Propranolol|Atenolol|Carvedilol|Lisinopril|Enalapril|Captopril|Losartan|Amlodipine|Nifedipine|Diltiazem|Verapamil|Furosemide|Lasix|Hydrochlorothiazide|HCTZ|Spironolactone|Aldactone|Mannitol|Phenytoin|Dilantin|Carbamazepine|Tegretol|Depakote|Levodopa|Sinemet|Lithium|Haloperidol|Haldol|Chlorpromazine|Thorazine|Clozapine|Risperidone|Olanzapine|Quetiapine|Diazepam|Valium|Lorazepam|Ativan|Midazolam|Flumazenil|Naloxone|Narcan|Insulin|Metformin|Glucagon|Levothyroxine|Synthroid|PTU|Propylthiouracil|Methimazole|Prednisone|Dexamethasone|Methylprednisolone|Solumedrol|Hydrocortisone|Aspirin|Acetaminophen|Tylenol|Ibuprofen|Ketorolac|Toradol|Gentamicin|Vancomycin|Penicillin|Amoxicillin|Ampicillin|Cephalosporin|Ciprofloxacin|Rifampin|Isoniazid|INH|Ethambutol|Pyrazinamide|Streptomycin|Methotrexate|Cyclophosphamide|Cisplatin|Doxorubicin|Vincristine|Tamoxifen|Protamine|Phytonadione|Propofol|Nitroprusside|Theophylline|Aminophylline|Albuterol|Ipratropium|Omeprazole|Pantoprazole|Ranitidine|Famotidine|Sucralfate|Metoclopramide|Ondansetron|Zofran|Lactulose|Docusate|Clopidogrel|Plavix|Alteplase|tPA|Streptokinase|Oxytocin|Pitocin|MgSO4|Terbutaline|Methylergonovine|Methergine|RhoGAM|Betamethasone|Surfactant|Acyclovir|Zidovudine|AZT|Fluoxetine|Sertraline|Paroxetine|Venlafaxine|Bupropion|Trazodone|Phenelzine|Disulfiram|Antabuse|Methadone|Donepezil|Aricept|Tacrine|Gabapentin|Succinylcholine|Epoetin|Filgrastim',
                'hl-lyte': 'Potassium|Sodium|Calcium|Magnesium|Phosphorus|Phosphate|Chloride|Bicarbonate',
                'hl-gas': 'Oxygen|O2|CO2'
            };
            for (var cls in lists) {
                lists[cls].split('|').forEach(function(t) {
                    _termMap[t.toLowerCase()] = cls;
                    _termPats.push(t);
                });
            }
            _termPats.sort(function(a, b) { return b.length - a.length; });
        })();
        var _termRx = new RegExp('\\b(' + _termPats.map(function(t) {
            return t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }).join('|') + ')\\b', 'gi');
        var _warnRx = /\b(Never|Danger|Fatal|Lethal|Contraindicated|Deadly|Life-threatening|Toxicity)\b/gi;
        var _cautRx = /\b(Avoid|Caution|Watch for|Risk of|Do not)\b/gi;
        var _nursRx = /\b(Tx:|Hold if|Elevate|Notify|Administer|Position)\b/gi;

        function fmtText(t, opts) {
            if (!t) return '';
            var noC = opts && opts.noCaut;
            var parts = t.split(/(<[^>]+>)/);
            for (var i = 0; i < parts.length; i++) {
                if (parts[i].charAt(0) !== '<') {
                    parts[i] = parts[i].replace(_termRx, function(m) {
                        var c = _termMap[m.toLowerCase()];
                        return c ? '<span class="' + c + '">' + m + '</span>' : m;
                    });
                    parts[i] = parts[i].replace(_warnRx, '\uD83D\uDEA8 $1');
                    if (!noC) parts[i] = parts[i].replace(_cautRx, '\u26A0\uFE0F $1');
                    parts[i] = parts[i].replace(_nursRx, '\uD83E\uDE7A $1');
                }
            }
            return parts.join('');
        }

        function fmtAlert(txt) {
            if (!txt) return '';
            txt = fmtText(txt, { noCaut: true });
            var m = txt.match(/^(.*?(?:[:=.!]|<\/span>))\s*/);
            if (m && m[1].length < txt.length) return '<span class="alert-key">' + m[1] + '</span> ' + txt.slice(m[0].length);
            return '<span class="alert-key">' + txt + '</span>';
        }

        function renderContent() {
            var data = contentData[currentTab];
            var summary = sectionSummaries[currentTab] || '';
            var rows = '';
            for (var i = 0; i < data.data.length; i++) {
                var item = data.data[i];
                rows += '<tr onclick="selectRow(this, ' + i + ')"><td class="topic-cell ' + data.type + '">' + fmtText(item.topic) + '</td><td class="key-point-cell">' + fmtText(item.fact) + '</td><td class="alert-cell">' + fmtAlert(item.alert) + '</td></tr>';
            }
            document.getElementById('content-area').innerHTML =
                '<div class="section-header-bar ' + data.color + '"><span class="section-title-hl">' + data.title + '</span>' +
                '<div class="header-btns"><button class="header-btn" onclick="openCards(0)">\uD83D\uDCC4 Study Cards</button>' +
                '<button class="header-btn" onclick="startQuiz()">\uD83E\uDDE0 Quiz Me</button></div>' +
                (summary ? '<div class="section-summary">' + summary + '</div>' : '') + '</div>' +
                '<div class="table-container"><table><thead><tr><th>\uD83D\uDCA1 Topic</th><th>\uD83C\uDFAF Key Point</th><th>\u26A0\uFE0F Alert</th></tr></thead>' +
                '<tbody id="table-body">' + rows + '</tbody></table></div>';
        }

        window.selectRow = function(rowEl, index) {
            var trs = document.querySelectorAll('#table-body tr');
            for (var i = 0; i < trs.length; i++) trs[i].classList.remove('selected');
            rowEl.classList.add('selected');
            openCards(index);
        };

        function fetchGitHubQuiz(sectionKey) {
            if (ghQuizCache[sectionKey]) return Promise.resolve(ghQuizCache[sectionKey]);
            var url = GH_CDN + 'mnt_quiz_json_' + sectionKey + '.json' + CACHE_BUST;
            return fetch(url).then(function(r) {
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return r.json().then(function(j) {
                    var qs = (j.questions || []).map(function(item) {
                        return { q: item.q, a: item.options || item.a, correct: item.correct, rationale: item.rationale };
                    });
                    ghQuizCache[sectionKey] = qs;
                    return qs;
                });
            }).catch(function() { return []; });
        }

        window.startQuiz = function() {
            var data = contentData[currentTab];
            document.getElementById('quiz-modal').style.display = 'flex';
            document.getElementById('quiz-progress').textContent = 'Loading questions...';
            document.getElementById('q-text').textContent = '';
            document.getElementById('q-options').innerHTML = '';
            document.getElementById('feedback-area').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            fetchGitHubQuiz(data.type).then(function(quizQs) {
                if (quizQs.length === 0) { document.getElementById('quiz-progress').textContent = 'No questions available yet.'; return; }
                currentQuizData = shuffleArray(quizQs);
                quizIndex = 0; quizScore = 0; showQuestion();
            });
        };

        function showQuestion() {
            var item = currentQuizData[quizIndex];
            var total = currentQuizData.length;
            document.getElementById('quiz-progress').textContent = 'Question ' + (quizIndex + 1) + ' of ' + total;
            document.getElementById('q-num-display').textContent = quizIndex + 1;
            document.getElementById('q-text').textContent = item.q;
            document.getElementById('feedback-area').style.display = 'none';
            document.getElementById('feedback-area').classList.remove('is-visible');
            document.getElementById('next-btn').style.display = 'none';
            var letters = ['A', 'B', 'C', 'D'];
            var optHTML = '';
            for (var i = 0; i < item.a.length; i++) {
                optHTML += '<button class="quiz-option" onclick="checkAnswer(' + i + ', ' + item.correct + ')"><span class="quiz-option-letter">' + letters[i] + '</span><span>' + item.a[i] + '</span></button>';
            }
            document.getElementById('q-options').innerHTML = optHTML;
        }

        window.checkAnswer = function(selected, correct) {
            var buttons = document.querySelectorAll('.quiz-option');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = true; buttons[i].style.pointerEvents = 'none';
                if (i === correct) buttons[i].classList.add('correct-choice');
                else if (i === selected && selected !== correct) buttons[i].classList.add('wrong-choice');
            }
            var item = currentQuizData[quizIndex];
            var fh = document.getElementById('feedback-header');
            if (selected === correct) {
                quizScore++; fh.className = 'feedback-header correct'; fh.innerHTML = '\u2714\uFE0F Correct!'; playSound('correct');
            } else {
                fh.className = 'feedback-header incorrect'; fh.innerHTML = '\u274C Incorrect'; playSound('wrong');
            }
            document.getElementById('rationale-text').textContent = item.rationale;
            document.getElementById('feedback-area').style.display = 'block';
            document.getElementById('feedback-area').classList.add('is-visible');
            document.getElementById('next-btn').style.display = 'block';
            document.getElementById('next-btn').textContent = (quizIndex >= currentQuizData.length - 1) ?
                'Finish (' + quizScore + '/' + currentQuizData.length + ')' : 'Next Question';
            setTimeout(function() { document.getElementById('next-btn').scrollIntoView({ behavior: 'smooth', block: 'end' }); }, 100);
        };

        window.nextQuestion = function() {
            quizIndex++;
            if (quizIndex < currentQuizData.length) { showQuestion(); document.getElementById('quiz-modal').scrollTop = 0; }
            else { closeQuiz(); }
        };
        window.closeQuiz = function() { document.getElementById('quiz-modal').style.display = 'none'; };

        /* ===== PDF VIEWER ===== */
        var pdfDoc = null;
        var pdfPageNum = 1;
        var pdfScale = 1.0;
        var pdfCurrentUrl = '';
        var pdfConfigCache = null;
        var pdfJsLoaded = false;

        function loadPdfJs(cb) {
            if (pdfJsLoaded) { cb(); return; }
            var s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
            s.onload = function() {
                fetch('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js')
                    .then(function(r) { return r.blob(); })
                    .then(function(b) {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = URL.createObjectURL(b);
                        pdfJsLoaded = true;
                        cb();
                    });
            };
            document.head.appendChild(s);
        }

        var PDF_CONFIG = {
            categories: [
                { name: 'Klimek Lectures', icon: '\uD83C\uDF93', items: [
                    { title: 'Lecture 1', file: 'Klimek Lecture 1.pdf' },
                    { title: 'Lecture 2', file: 'Klimek Lecture 2.pdf' },
                    { title: 'Lecture 3', file: 'Klimek Lecture 3.pdf' },
                    { title: 'Lecture 4', file: 'Klimek Lecture 4.pdf' },
                    { title: 'Lecture 5', file: 'Klimek Lecture 5.pdf' },
                    { title: 'Lecture 6', file: 'Klimek Lecture 6.pdf' },
                    { title: 'Lecture 7', file: 'Klimek Lecture 7.pdf' },
                    { title: 'Lecture 8', file: 'Klimek Lecture 8.pdf' },
                    { title: 'Lecture 9', file: 'Klimek Lecture 9.pdf' },
                    { title: 'Lecture 10', file: 'Klimek Lecture 10.pdf' },
                    { title: 'Lecture 11', file: 'Klimek Lecture 11.pdf' },
                    { title: 'Lecture 12', file: 'Klimek Lecture 12.pdf' }
                ]},
                { name: 'Klimek Books', icon: '\uD83D\uDCDA', items: [
                    { title: 'Blue Book', file: '1. Blue Book.pdf' },
                    { title: 'Yellow Book', file: '2. Yellow Book.pdf' },
                    { title: 'Black Book', file: 'BlackBook.pdf' }
                ]},
                { name: 'Crib Notes', icon: '\uD83D\uDCDD', items: [
                    { title: 'Quizlet - 2000 Questions', file: 'Klimek Quizlet - 2000 Questions.pdf' },
                    { title: 'Study Plan', file: 'Study Plan.pdf' }
                ]},
                { name: 'Pharmacology', icon: '\uD83D\uDC8A', items: [
                    { title: 'Lab Values', file: 'Klimek Lab Values.pdf' },
                    { title: 'Vital Protocols - Steam', file: 'Vital Protocols - Steam.pdf' }
                ]},
                { name: 'Expanded Guides', icon: '\uD83D\uDCD6', items: [
                    { title: 'Klimek Review', file: 'Klimek Review.pdf' },
                    { title: 'Lecture Notes - 92 Pages', file: 'Lecture Notes - 92 Pages.pdf' },
                    { title: 'Graphics - 29 Pages', file: 'Lecture Notes - Graphics 29 Pages.pdf' }
                ]}
            ]
        };

        function loadPdfConfig(cb) {
            if (pdfConfigCache) { cb(pdfConfigCache); return; }
            pdfConfigCache = PDF_CONFIG;
            cb(PDF_CONFIG);
        }

        function renderPdfSidebar(config) {
            var sb = document.getElementById('pdf-sidebar');
            var cats = config.categories || [];
            if (cats.length === 0) {
                sb.innerHTML = '<div class="pdf-loading" style="color:#f59e0b;">No PDFs found.<br><small>Files may not be uploaded yet.</small></div>';
                return;
            }
            var html = '';
            for (var c = 0; c < cats.length; c++) {
                var cat = cats[c];
                html += '<div class="pdf-sidebar-cat" onclick="togglePdfCat(this)">' +
                    '<span class="cat-arrow open">\u25B6</span>' +
                    '<span>' + (cat.icon || '\uD83D\uDCC1') + ' ' + cat.name + '</span></div>' +
                    '<div class="pdf-sidebar-items">';
                var items = cat.items || [];
                for (var t = 0; t < items.length; t++) {
                    html += '<div class="pdf-sidebar-item" data-file="' + encodeURIComponent(items[t].file) + '" onclick="selectPdf(this, decodeURIComponent(this.getAttribute(\'data-file\')))">' +
                        '\uD83D\uDCC4 ' + items[t].title + '</div>';
                }
                html += '</div>';
            }
            sb.innerHTML = html;
        }

        window.togglePdfCat = function(el) {
            var items = el.nextElementSibling;
            var arrow = el.querySelector('.cat-arrow');
            if (items.style.display === 'none') {
                items.style.display = '';
                arrow.classList.add('open');
            } else {
                items.style.display = 'none';
                arrow.classList.remove('open');
            }
        };

        window.selectPdf = function(el, file) {
            var allItems = document.querySelectorAll('.pdf-sidebar-item');
            for (var i = 0; i < allItems.length; i++) allItems[i].classList.remove('active');
            el.classList.add('active');
            pdfDoc = null;
            pdfPageNum = 1;
            pdfScale = 1.0;
            var url = GH_PAGES + 'pdfs/' + encodeURIComponent(file);
            pdfCurrentUrl = url;
            document.getElementById('pdf-toolbar').style.display = 'none';
            document.getElementById('pdf-canvas-wrap').innerHTML =
                '<div class="pdf-loading">Loading PDF\u2026</div><canvas id="pdf-canvas" style="display:none;"></canvas>';
            loadPdfJs(function() {
                pdfjsLib.getDocument(url).promise.then(function(pdf) {
                    if (pdfCurrentUrl !== url) return;
                    pdfDoc = pdf;
                    document.getElementById('pdf-toolbar').style.display = 'flex';
                    renderPdfPage();
                }).catch(function(err) {
                    if (pdfCurrentUrl !== url) return;
                    document.getElementById('pdf-toolbar').style.display = 'none';
                    document.getElementById('pdf-canvas-wrap').innerHTML =
                        '<div class="pdf-placeholder" style="color:#f87171;">Failed to load PDF.<br><small style="color:#94a3b8;">' + err.message + '</small></div>';
                });
            });
        };

        function renderPdfPage() {
            pdfDoc.getPage(pdfPageNum).then(function(page) {
                var viewport = page.getViewport({ scale: pdfScale * 1.5 });
                var canvas = document.getElementById('pdf-canvas');
                if (!canvas) {
                    document.getElementById('pdf-canvas-wrap').innerHTML = '<canvas id="pdf-canvas"></canvas>';
                    canvas = document.getElementById('pdf-canvas');
                }
                var ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.display = 'block';
                var loadingMsg = document.querySelector('#pdf-canvas-wrap .pdf-loading');
                if (loadingMsg) loadingMsg.remove();
                page.render({ canvasContext: ctx, viewport: viewport });
                document.getElementById('pdf-page-info').textContent = 'Page ' + pdfPageNum + ' of ' + pdfDoc.numPages;
                document.getElementById('pdf-zoom-info').textContent = Math.round(pdfScale * 100) + '%';
                document.getElementById('pdf-prev').disabled = (pdfPageNum <= 1);
                document.getElementById('pdf-next').disabled = (pdfPageNum >= pdfDoc.numPages);
            });
        }

        window.closePdf = function() {
            pdfDoc = null;
            pdfCurrentUrl = '';
            pdfPageNum = 1;
            pdfScale = 1.0;
            document.getElementById('pdf-toolbar').style.display = 'none';
            document.getElementById('pdf-canvas-wrap').innerHTML =
                '<div class="pdf-placeholder" id="pdf-placeholder">Select a PDF from the menu to begin studying</div>' +
                '<canvas id="pdf-canvas" style="display:none;"></canvas>';
            var allItems = document.querySelectorAll('.pdf-sidebar-item');
            for (var i = 0; i < allItems.length; i++) allItems[i].classList.remove('active');
        };
        window.pdfPrevPage = function() { if (pdfPageNum > 1) { pdfPageNum--; renderPdfPage(); document.getElementById('pdf-canvas-wrap').scrollTop = 0; } };
        window.pdfNextPage = function() { if (pdfDoc && pdfPageNum < pdfDoc.numPages) { pdfPageNum++; renderPdfPage(); document.getElementById('pdf-canvas-wrap').scrollTop = 0; } };
        window.pdfZoomIn = function() { if (pdfScale < 3) { pdfScale = Math.round((pdfScale + 0.25) * 100) / 100; renderPdfPage(); } };
        window.pdfZoomOut = function() { if (pdfScale > 0.25) { pdfScale = Math.round((pdfScale - 0.25) * 100) / 100; renderPdfPage(); } };
        window.pdfDownload = function() {
            if (!pdfCurrentUrl) return;
            var a = document.createElement('a');
            a.href = pdfCurrentUrl;
            a.download = decodeURIComponent(pdfCurrentUrl.split('/').pop());
            a.click();
        };

        window.showPDFs = function() {
            document.getElementById('home-dashboard').style.display = 'none';
            document.getElementById('section-view').style.display = 'none';
            document.getElementById('pdf-view').style.display = 'block';
            document.getElementById('home-back-btn').style.display = 'inline-block';
            document.getElementById('nav-filters').style.display = 'none';
            if (!pdfConfigCache) {
                document.getElementById('pdf-sidebar').innerHTML =
                    '<div class="pdf-loading">Loading PDF menu\u2026</div>';
            }
            loadPdfConfig(function(config) { renderPdfSidebar(config); });
        };
        /* ===== END PDF VIEWER ===== */

        /* ===== GLOBAL SEARCH ===== */
        var searchTimeout = null;
        window.doGlobalSearch = function(query) {
            clearTimeout(searchTimeout);
            var resultsDiv = document.getElementById('search-results');
            var gridDiv = document.getElementById('home-grid');
            if (!query || query.length < 2) { resultsDiv.style.display = 'none'; gridDiv.style.display = ''; return; }
            searchTimeout = setTimeout(function() {
                var q = query.toLowerCase();
                var matches = [];
                var keys = Object.keys(contentData);
                for (var k = 0; k < keys.length; k++) {
                    var sec = contentData[keys[k]];
                    var emoji = sectionEmojis[keys[k]] || '';
                    for (var c = 0; c < sec.data.length; c++) {
                        var card = sec.data[c];
                        var text = (card.topic + ' ' + card.fact + ' ' + card.alert + ' ' + card.q + ' ' + card.rationale).toLowerCase();
                        if (text.indexOf(q) !== -1) {
                            matches.push({ section: keys[k], sectionTitle: sec.title, emoji: emoji, cardIdx: c, card: card, color: sec.color });
                        }
                    }
                    if (matches.length >= 50) break;
                }
                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align:center; opacity:0.6; padding:1rem;">No cards found for &ldquo;' + query.replace(/</g,'&lt;') + '&rdquo;</p>';
                } else {
                    var html = '<p style="font-size:0.85rem; opacity:0.7; margin-bottom:0.5rem;">' + matches.length + (matches.length >= 50 ? '+' : '') + ' results</p>';
                    for (var m = 0; m < matches.length; m++) {
                        var item = matches[m];
                        var plainFact = item.card.fact.replace(/<[^>]*>/g, '');
                        if (plainFact.length > 100) plainFact = plainFact.substring(0, 100) + '...';
                        html += '<div class="search-result-item" '
                            + 'onclick="document.getElementById(\'global-search\').value=\'\'; doGlobalSearch(\'\'); switchTab(\'' + item.section + '\'); openCards(' + item.cardIdx + ');">'
                            + '<div style="font-weight:600; font-size:0.95rem;">' + item.emoji + ' ' + item.card.topic + '</div>'
                            + '<div style="font-size:0.82rem; opacity:0.7;">' + item.sectionTitle + ' &bull; ' + plainFact + '</div></div>';
                    }
                    resultsDiv.innerHTML = html;
                }
                resultsDiv.style.display = 'block';
                gridDiv.style.display = matches.length > 0 ? 'none' : '';
            }, 200);
        };
        /* ===== END GLOBAL SEARCH ===== */

        /* ===== KEYBOARD & TOUCH SUPPORT ===== */
        document.addEventListener('keydown', function(e) {
            var cardModal = document.getElementById('card-modal');
            var quizModal = document.getElementById('quiz-modal');
            if (e.key === 'Escape') {
                if (quizModal.style.display === 'flex') { closeQuiz(); e.preventDefault(); }
                else if (cardModal.style.display === 'flex') { closeCards(); e.preventDefault(); }
            }
            if (cardModal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') { prevCard(); e.preventDefault(); }
                if (e.key === 'ArrowRight') { nextCard(); e.preventDefault(); }
            }
        });
        /* Touch swipe for study cards */
        (function() {
            var touchStartX = 0, touchEndX = 0, minSwipe = 50;
            var modal = document.getElementById('card-modal');
            modal.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            modal.addEventListener('touchend', function(e) {
                touchEndX = e.changedTouches[0].screenX;
                var diff = touchStartX - touchEndX;
                if (Math.abs(diff) > minSwipe) {
                    if (diff > 0) nextCard(); else prevCard();
                }
            }, { passive: true });
        })();
        /* ===== END KEYBOARD & TOUCH ===== */

        showHome();

        } // end initApp
    })();
    </script>
</div>
</body>
</html>